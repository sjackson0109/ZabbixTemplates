zabbix_export:
  version: '7.0'
  date: '2025-07-16T12:00:00Z'
  groups:
    - name: Templates
  templates:
    - name: 'Alien Vault OTX'
      value_maps:
        - name: 'OTX IOC Severity Map'
          mappings:
            - value: '0'
              newvalue: 'None'
            - value: '1-3'
              newvalue: 'Low'
            - value: '4-6'
              newvalue: 'Medium'
            - value: '7-10'
              newvalue: 'High'
      description: |-
        Automated monitoring of AlienVault OTX (Open Threat Exchange) threat intelligence in Zabbix.
        This template uses an external Python script to:
        - Discover and track IOCs (Indicators of Compromise) from OTX pulses within a configurable time window
        - Enrich each IOC with metadata: first seen, last seen, pulse name, tags, references, and threat type
        - Monitor IOC severity/confidence and trigger alerts for high-severity threats
        - Track pulse count and last update time for OTX data
        - Provide robust error handling and Zabbix-friendly output (safe defaults, clear errors)
        - Support flexible configuration via macros and environment variables (API key, endpoint, timeout, debug)
        - Optimize performance with in-script caching to minimize redundant API calls

        Author: Simon Jackson / @sjackson0109
      groups:
        - name: Templates
      macros:
        - macro: '{$OTX_API_KEY}'
          value: ''
        - macro: '{$OTX_SINCE_HOURS}'
          value: '24'
        - macro: '{$SEVERITY_THRESHOLD}'
          value: '7'
      items:
        - name: 'OTX Pulses Count (last {$OTX_SINCE_HOURS}h)'
          type: EXTERNAL
          key: 'otx.pulses[{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
          delay: 1h
          history: 90d
          trends: 365d
          value_type: UNSIGNED
        - name: 'OTX Last Update Time'
          type: EXTERNAL
          key: 'otx.lastupdate[{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
          delay: 1h
          history: 30d
          trends: 365d
          value_type: TEXT
        - name: 'OTX API Health Status'
          type: EXTERNAL
          key: 'otx.health[{$OTX_API_KEY}]'
          delay: 1h
          history: 30d
          trends: 365d
          value_type: TEXT
      discovery_rules:
        - name: 'AlienVault OTX IOC Discovery'
          type: EXTERNAL
          key: 'otx.discover[{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
          delay: 1h
          filter:
            conditions:
              - macro: '{#VALUE}'
                operator: MATCHES_REGEX
                value: '.+'
          item_prototypes:
            - name: 'OTX IOC {#TYPE}: {#VALUE}'
              type: EXTERNAL
              key: 'otx.ioc[{#TYPE},{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              delay: 1h
              history: 30d
              trends: 365d
              value_type: TEXT
            - name: 'OTX IOC Severity {#TYPE}: {#VALUE}'
              type: EXTERNAL
              key: 'otx.severity[{#TYPE},{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              delay: 1h
              history: 30d
              trends: 365d
              value_type: UNSIGNED
            - name: 'OTX IOC First Seen {#TYPE}: {#VALUE}'
              type: DEPENDENT
              key: 'otx.ioc.first_seen[{#TYPE},{#VALUE}]'
              master_item:
                key: 'otx.ioc[{#TYPE},{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              delay: '0'
              value_type: TEXT
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.{#FIRST_SEEN}'
            - name: 'OTX IOC Last Seen {#TYPE}: {#VALUE}'
              type: DEPENDENT
              key: 'otx.ioc.last_seen[{#TYPE},{#VALUE}]'
              master_item:
                key: 'otx.ioc[{#TYPE},{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              delay: '0'
              value_type: TEXT
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.{#LAST_SEEN}'
            - name: 'OTX IOC Pulse Name {#TYPE}: {#VALUE}'
              type: DEPENDENT
              key: 'otx.ioc.pulse_name[{#TYPE},{#VALUE}]'
              master_item:
                key: 'otx.ioc[{#TYPE},{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              delay: '0'
              value_type: TEXT
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.{#PULSE_NAME}'
            - name: 'OTX IOC Tags {#TYPE}: {#VALUE}'
              type: DEPENDENT
              key: 'otx.ioc.tags[{#TYPE},{#VALUE}]'
              master_item:
                key: 'otx.ioc[{#TYPE},{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              delay: '0'
              value_type: TEXT
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.{#TAGS}'
            - name: 'OTX IOC References {#TYPE}: {#VALUE}'
              type: DEPENDENT
              key: 'otx.ioc.references[{#TYPE},{#VALUE}]'
              master_item:
                key: 'otx.ioc[{#TYPE},{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              delay: '0'
              value_type: TEXT
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.{#REFERENCES}'
            - name: 'OTX IOC Threat Type {#TYPE}: {#VALUE}'
              type: DEPENDENT
              key: 'otx.ioc.threat_type[{#TYPE},{#VALUE}]'
              master_item:
                key: 'otx.ioc[{#TYPE},{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              delay: '0'
              value_type: TEXT
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.{#THREAT_TYPE}'
          trigger_prototypes:
            - name: 'High severity OTX IOC {#TYPE}: {#VALUE}'
              expression: 'last(/Alien Vault OTX/otx.severity[{#TYPE},{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}])>{$SEVERITY_THRESHOLD}'
              priority: WARNING
            - name: 'High severity OTX IP IOC: {#VALUE}'
              expression: 'last(/Alien Vault OTX/otx.severity[ip,{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}])>{$SEVERITY_THRESHOLD}'
              priority: HIGH
            - name: 'High severity OTX Domain IOC: {#VALUE}'
              expression: 'last(/Alien Vault OTX/otx.severity[domain,{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}])>{$SEVERITY_THRESHOLD}'
              priority: HIGH
            - name: 'High severity OTX URL IOC: {#VALUE}'
              expression: 'last(/Alien Vault OTX/otx.severity[url,{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}])>{$SEVERITY_THRESHOLD}'
              priority: HIGH
            - name: 'High severity OTX Hash IOC: {#VALUE}'
              expression: 'last(/Alien Vault OTX/otx.severity[file_hash,{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}])>{$SEVERITY_THRESHOLD}'
              priority: HIGH
            - name: 'OTX IOC with Ransomware Tag: {#VALUE}'
              expression: 'find(/Alien Vault OTX/otx.ioc.tags[{#TYPE},{#VALUE}],,"ransomware")=1'
              priority: DISASTER
            - name: 'OTX IOC with Phishing Tag: {#VALUE}'
              expression: 'find(/Alien Vault OTX/otx.ioc.tags[{#TYPE},{#VALUE}],,"phishing")=1'
              priority: HIGH
      triggers:
        - name: 'No new OTX indicators in last {$OTX_SINCE_HOURS} hours'
          expression: 'last(/Alien Vault OTX/otx.pulses[{$OTX_API_KEY},{$OTX_SINCE_HOURS}])=0'
          priority: AVERAGE
        - name: 'OTX data not updated for over 2 hours'
          expression: 'nodata(/Alien Vault OTX/otx.lastupdate[{$OTX_API_KEY},{$OTX_SINCE_HOURS}],2h)=1'
          priority: HIGH
zabbix_export:
  version: '7.0'
  date: '2025-07-16T12:00:00Z'
  groups:
    - name: Templates
  templates:
    - name: 'Alien Vault OTX'
      description: |-
        Automated monitoring of AlienVault OTX (Open Threat Exchange) threat intelligence in Zabbix.
        This template uses an external Python script to:
        - Discover and track IOCs (Indicators of Compromise) from OTX pulses within a configurable time window
        - Enrich each IOC with metadata: first seen, last seen, pulse name, tags, references, and threat type
        - Monitor IOC severity/confidence and trigger alerts for high-severity threats
        - Track pulse count and last update time for OTX data
        - Provide robust error handling and Zabbix-friendly output (safe defaults, clear errors)
        - Support flexible configuration via macros and environment variables (API key, endpoint, timeout, debug)
        - Optimize performance with in-script caching to minimize redundant API calls

        Author: Simon Jackson / @sjackson0109
      groups:
        - name: Templates
      items:
        - uuid: 'b3b6e2e24c2d4e3a94b8a2b3c4d5e6f1'
          name: 'OTX Pulses Count (last {$OTX_SINCE_HOURS}h)'
          type: EXTERNAL
          key: 'otx.pulses[{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
          delay: 1h
          history: 90d
          trends: 365d
          value_type: UNSIGNED
          tags:
            - tag: otx_type
              value: 'pulse_count'
            - tag: integration
              value: 'alienvault_otx'
        - uuid: 'b7e2c4e14a2b4c4d94b8a2b3c4d5e6f2'
          name: 'OTX Last Update Time'
          type: EXTERNAL
          key: 'otx.lastupdate[{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
          delay: 1h
          history: 30d
          trends: 365d
          value_type: TEXT
          tags:
            - tag: otx_type
              value: 'last_update'
            - tag: integration
              value: 'alienvault_otx'
        - uuid: 'e6f1a2b34c5d4e3194b8a2b3c4d5e6f3'
          name: 'OTX API Health Status'
          type: EXTERNAL
          key: 'otx.health[{$OTX_API_KEY}]'
          delay: 1h
          history: 30d
          trends: 365d
          value_type: TEXT
          tags:
            - tag: otx_type
              value: 'api_health'
            - tag: integration
              value: 'alienvault_otx'
      discovery_rules:
        - uuid: 'f1a2b3c44d5e4fa294b8a2b3c4d5e6f4'
          name: 'AlienVault OTX IOC Discovery'
          type: EXTERNAL
          key: 'otx.discover[{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
          delay: 1h
          filter:
            conditions:
              # Only include IOCs with non-empty values
              - macro: '{#VALUE}'
                operator: MATCHES_REGEX
                value: '.+'
              # Minimum severity filter
              - macro: '{#SEVERITY}'
                operator: GREATER_OR_EQUAL
                value: '{$OTX_MIN_SEVERITY}'
              # Include/exclude IOC types if macros are set
              - macro: '{#TYPE}'
                operator: IN
                value: '{$OTX_INCLUDE_TYPES}'
              # Exclude IOC types if macros are set
              - macro: '{#TYPE}'
                operator: NOT_IN
                value: '{$OTX_EXCLUDE_TYPES}'
              # Exclude IOCs with certain tags
              - macro: '{#TAGS}'
                operator: NOT_MATCHES_REGEX
                value: '{$OTX_EXCLUDE_TAGS}'
          item_prototypes:
            # Type-specific severity item prototypes for granular triggers
            - uuid: 'a1b2c3d44e5641b294b8a2b3c4d5e6f5'
              name: 'OTX IOC Severity IP: {#VALUE}'
              type: EXTERNAL
              key: 'otx.severity[ip,{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              delay: 1h
              history: 30d
              trends: 365d
              value_type: UNSIGNED
              preprocessing:
                - type: JAVASCRIPT
                  parameters:
                    - 'return ("ip" === value["{#TYPE}"]) ? value["{#SEVERITY}"] : null;'
              tags:
                - tag: ioc_type
                  value: '{#TYPE}'
                - tag: otx_tag
                  value: '{#TAGS}'
                - tag: threat_type
                  value: '{#THREAT_TYPE}'
            # Domain severity item prototype
            - uuid: 'b2c3d4e54a6a41b394b8a2b3c4d5e6f6'
              name: 'OTX IOC Severity Domain: {#VALUE}'
              type: EXTERNAL
              key: 'otx.severity[domain,{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              delay: 1h
              history: 30d
              trends: 365d
              value_type: UNSIGNED
              preprocessing:
                - type: JAVASCRIPT
                  parameters:
                    - 'return ("domain" === value["{#TYPE}"]) ? value["{#SEVERITY}"] : null;'
              tags:
                - tag: ioc_type
                  value: '{#TYPE}'
                - tag: otx_tag
                  value: '{#TAGS}'
                - tag: threat_type
                  value: '{#THREAT_TYPE}'
            # URL severity item prototype
            - uuid: 'c3d4e5f64a1b41b494b8a2b3c4d5e6f7'
              name: 'OTX IOC Severity URL: {#VALUE}'
              type: EXTERNAL
              key: 'otx.severity[url,{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              delay: 1h
              history: 30d
              trends: 365d
              value_type: UNSIGNED
              preprocessing:
                - type: JAVASCRIPT
                  parameters:
                    - 'return ("url" === value["{#TYPE}"]) ? value["{#SEVERITY}"] : null;'
              tags:
                - tag: ioc_type
                  value: '{#TYPE}'
                - tag: otx_tag
                  value: '{#TAGS}'
                - tag: threat_type
                  value: '{#THREAT_TYPE}'
            # Hash severity item prototype
            - uuid: 'd4e5f6a14b2c41b594b8a2b3c4d5e6f8'
              name: 'OTX IOC Severity Hash: {#VALUE}'
              type: EXTERNAL
              key: 'otx.severity[file_hash,{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              delay: 1h
              history: 30d
              trends: 365d
              value_type: UNSIGNED
              preprocessing:
                - type: JAVASCRIPT
                  parameters:
                    - 'return ("file_hash" === value["{#TYPE}"]) ? value["{#SEVERITY}"] : null;'
              tags:
                - tag: ioc_type
                  value: '{#TYPE}'
                - tag: otx_tag
                  value: '{#TAGS}'
                - tag: threat_type
                  value: '{#THREAT_TYPE}'
            # Generic IOC item prototypes
            - uuid: 'e5f6a1b24c3d41b694b8a2b3c4d5e6f9'
              name: 'OTX IOC {#TYPE}: {#VALUE}'
              type: EXTERNAL
              key: 'otx.ioc[{#TYPE},{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              delay: 1h
              history: 30d
              trends: 365d
              value_type: TEXT
              tags:
                - tag: ioc_type
                  value: '{#TYPE}'
                - tag: otx_tag
                  value: '{#TAGS}'
                - tag: threat_type
                  value: '{#THREAT_TYPE}'
            # Generic severity item prototype
            - uuid: 'f6a1b2c34d5f41b794b8a2b3c4d5e6fa'
              name: 'OTX IOC Severity {#TYPE}: {#VALUE}'
              type: EXTERNAL
              key: 'otx.severity[{#TYPE},{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              delay: 1h
              history: 30d
              trends: 365d
              value_type: UNSIGNED
              tags:
                - tag: ioc_type
                  value: '{#TYPE}'
                - tag: otx_tag
                  value: '{#TAGS}'
                - tag: threat_type
                  value: '{#THREAT_TYPE}'
            # Metadata item prototypes
            - uuid: 'a2b3c4d54e6f41b894b8a2b3c4d5e6fb'
              name: 'OTX IOC First Seen {#TYPE}: {#VALUE}'
              type: DEPENDENT
              key: 'otx.ioc.first_seen[{#TYPE},{#VALUE}]'
              master_item:
                key: 'otx.ioc[{#TYPE},{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              delay: '0'
              value_type: TEXT
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.{#FIRST_SEEN}'
              tags:
                - tag: ioc_type
                  value: '{#TYPE}'
            # Last seen item prototype
            - uuid: 'b3c4d5e64f1a41b994b8a2b3c4d5e6fc'
              name: 'OTX IOC Last Seen {#TYPE}: {#VALUE}'
              type: DEPENDENT
              key: 'otx.ioc.last_seen[{#TYPE},{#VALUE}]'
              master_item:
                key: 'otx.ioc[{#TYPE},{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              delay: '0'
              value_type: TEXT
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.{#LAST_SEEN}'
              tags:
                - tag: ioc_type
                  value: '{#TYPE}'
            # Pulse name item prototype
            - uuid: 'c4d5e6f14a2b41ba94b8a2b3c4d5e6fd'
              name: 'OTX IOC Pulse Name {#TYPE}: {#VALUE}'
              type: DEPENDENT
              key: 'otx.ioc.pulse_name[{#TYPE},{#VALUE}]'
              master_item:
                key: 'otx.ioc[{#TYPE},{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              delay: '0'
              value_type: TEXT
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.{#PULSE_NAME}'
              tags:
                - tag: ioc_type
                  value: '{#TYPE}'
            # Tags item prototype
            - uuid: 'd5e6f1a24b3c41baa4b8a2b3c4d5e6fe'
              name: 'OTX IOC Tags {#TYPE}: {#VALUE}'
              type: DEPENDENT
              key: 'otx.ioc.tags[{#TYPE},{#VALUE}]'
              master_item:
                key: 'otx.ioc[{#TYPE},{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              delay: '0'
              value_type: TEXT
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.{#TAGS}'
              tags:
                - tag: ioc_type
                  value: '{#TYPE}'
            # References item prototype
            - uuid: 'e6f1a2b34c5d41bab4b8a2b3c4d5e6ff'
              name: 'OTX IOC References {#TYPE}: {#VALUE}'
              type: DEPENDENT
              key: 'otx.ioc.references[{#TYPE},{#VALUE}]'
              master_item:
                key: 'otx.ioc[{#TYPE},{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              delay: '0'
              value_type: TEXT
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.{#REFERENCES}'
              tags:
                - tag: ioc_type
                  value: '{#TYPE}'
            # Threat type item prototype
            - uuid: 'f1a2b3c44d5e41bbb4b8a2b3c4d5e6f0'
              name: 'OTX IOC Threat Type {#TYPE}: {#VALUE}'
              type: DEPENDENT
              key: 'otx.ioc.threat_type[{#TYPE},{#VALUE}]'
              master_item:
                key: 'otx.ioc[{#TYPE},{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              delay: '0'
              value_type: TEXT
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.{#THREAT_TYPE}'
              tags:
                - tag: ioc_type
                  value: '{#TYPE}'
          trigger_prototypes:
            # General API health trigger
            - uuid: 'a3b4c5d64e7f41bca4b8a2b3c4d5e6f1'
              name: 'OTX API health check failed'
              expression: 'find(/Alien Vault OTX/otx.health[{$OTX_API_KEY}],,"fail")=1'
              priority: HIGH
              tags:
                - tag: event
                  value: 'api_health_fail'
            # Severity-based triggers
            - uuid: 'b4c5d6e74f8a41bcb4b8a2b3c4d5e6f2'
              name: 'High severity OTX IP IOC: {#VALUE}'
              expression: 'last(/Alien Vault OTX/otx.severity[ip,{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}])>{$SEVERITY_THRESHOLD}'
              priority: HIGH
              tags:
                - tag: severity
                  value: 'high'
                - tag: ioc_type
                  value: '{#TYPE}'
            # Domain severity trigger
            - uuid: 'c5d6e7f84a3b41bc84b8a2b3c4d5e6f3'
              name: 'High severity OTX Domain IOC: {#VALUE}'
              expression: 'last(/Alien Vault OTX/otx.severity[domain,{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}])>{$SEVERITY_THRESHOLD}'
              priority: HIGH
              tags:
                - tag: severity
                  value: 'high'
                - tag: ioc_type
                  value: '{#TYPE}'
            # URL severity trigger
            - uuid: 'd6e7f8a34b5c41bc84b8a2b3c4d5e6f4'
              name: 'High severity OTX URL IOC: {#VALUE}'
              expression: 'last(/Alien Vault OTX/otx.severity[url,{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}])>{$SEVERITY_THRESHOLD}'
              priority: HIGH
              tags:
                - tag: severity
                  value: 'high'
                - tag: ioc_type
                  value: '{#TYPE}'
            # Hash severity trigger
            - uuid: 'e7f8a3b44c5d41bc84b8a2b3c4d5e6f5'
              name: 'High severity OTX Hash IOC: {#VALUE}'
              expression: 'last(/Alien Vault OTX/otx.severity[file_hash,{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}])>{$SEVERITY_THRESHOLD}'
              priority: HIGH
              tags:
                - tag: severity
                  value: 'high'
                - tag: ioc_type
                  value: '{#TYPE}'
            # Generic severity trigger
            - uuid: 'f8a3b4c54d6e41bc84b8a2b3c4d5e6f6'
              name: 'High severity OTX IOC {#TYPE}: {#VALUE}'
              expression: 'last(/Alien Vault OTX/otx.severity[{#TYPE},{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}])>{$SEVERITY_THRESHOLD}'
              priority: WARNING
              tags:
                - tag: severity
                  value: 'warning'
                - tag: ioc_type
                  value: '{#TYPE}'
            # Macro-driven tag triggers for critical tags
            - uuid: 'a4b5c6d74e8f41bd84b8a2b3c4d5e6f7'
              name: 'OTX IOC with Critical Tag: {#VALUE}'
              expression: 'regexp(/Alien Vault OTX/otx.ioc.tags[{#TYPE},{#VALUE}],"({$OTX_TAGS_CRITICAL})")=1'
              priority: DISASTER
              tags:
                - tag: severity
                  value: 'disaster'
                - tag: ioc_type
                  value: '{#TYPE}'
                - tag: otx_tag
                  value: '{#TAGS}'
            # Macro-driven tag triggers for high tags
            - uuid: 'b5c6d7e84f9a41bd94b8a2b3c4d5e6f8'
              name: 'OTX IOC with High Tag: {#VALUE}'
              expression: 'regexp(/Alien Vault OTX/otx.ioc.tags[{#TYPE},{#VALUE}],"({$OTX_TAGS_HIGH})")=1'
              priority: HIGH
              tags:
                - tag: severity
                  value: 'high'
                - tag: ioc_type
                  value: '{#TYPE}'
                - tag: otx_tag
                  value: '{#TAGS}'
            # Example: add more tag triggers as needed
        # Security: API key macro should be stored securely and never logged or exposed in UI or error messages.
        # WARNING: Do not expose API keys in logs, screens, or error messages. Use Zabbix secrets/vaults if available.
      triggers:
        # Overall monitoring triggers
        - uuid: 'c6d7e8f94a8b41be84b8a2b3c4d5e6f9'
          name: 'No new OTX indicators in last {$OTX_SINCE_HOURS} hours'
          expression: 'last(/Alien Vault OTX/otx.pulses[{$OTX_API_KEY},{$OTX_SINCE_HOURS}])=0'
          priority: AVERAGE
          tags:
            - tag: event
              value: 'no_new_iocs'
            - tag: integration
              value: 'alienvault_otx'
        # Data freshness trigger
        - uuid: 'd7e8f9a44b5c41bea4b8a2b3c4d5e6fa'
          name: 'OTX data not updated for over 2 hours'
          expression: 'nodata(/Alien Vault OTX/otx.lastupdate[{$OTX_API_KEY},{$OTX_SINCE_HOURS}],2h)=1'
          priority: HIGH
          tags:
            - tag: event
              value: 'data_stale'
            - tag: integration
              value: 'alienvault_otx'
      macros:
        - macro: '{$OTX_API_KEY}'
          value: ''
          description: 'AlienVault OTX API key (keep secret). Use Zabbix secrets/vault if available.'
        - macro: '{$OTX_API_ENDPOINT}'
          value: 'https://otx.alienvault.com/api/v1'
          description: 'OTX API endpoint URL (default: https://otx.alienvault.com/api/v1)'
        - macro: '{$OTX_TIMEOUT}'
          value: '30'
          description: 'OTX API request timeout in seconds (default: 30)'
        - macro: '{$OTX_SINCE_HOURS}'
          value: '24'
          description: 'Time window (hours) for IOC discovery (default: 24)'
        - macro: '{$SEVERITY_THRESHOLD}'
          value: '7'
          description: 'Minimum severity/confidence for alerting (default: 7)'
        - macro: '{$OTX_MIN_SEVERITY}'
          value: '1'
          description: 'Minimum severity/confidence for IOC discovery  (default: 1)'
        - macro: '{$OTX_INCLUDE_TYPES}'
          value: ''
          description: 'IOC types to include in discovery (e.g. IPv4,domain,URL), not blank=all'
        - macro: '{$OTX_EXCLUDE_TYPES}'
          value: ''
          description: 'IOC types to exclude from discovery (e.g. email,hostname)'
        - macro: '{$OTX_EXCLUDE_TAGS}'
          value: ''
          description: 'Tags to exclude from discovery (e.g. test,benign)'
        - macro: '{$OTX_TAGS_CRITICAL}'
          value: 'ransomware,phishing,malware,botnet,APT'
          description: 'Tags that trigger critical alerts (e.g. ransomware,phishing,malware)'
        - macro: '{$OTX_TAGS_HIGH}'
          value: 'exploit,ddos,spam'
          description: 'Tags that trigger high alerts'
      value_maps:
        - name: 'OTX IOC Severity Map'
          mappings:
            - value: '0'
              newvalue: 'None'
            - value: '1-3'
              newvalue: 'Low'
            - value: '4-6'
              newvalue: 'Medium'
            - value: '7-10'
              newvalue: 'High'
            - value: ''
              newvalue: 'Unknown'

zabbix_export:
  version: '7.0'
  template_groups:
    - uuid: 7df96b18c230490a9a0a9e2307226338
      name: Templates
  templates:
    - uuid: 7e2b4c8e4b2e4e4b9a8b4c8e4b2e4e4b
      template: 'Alien Vault OTX'
      name: 'Alien Vault OTX'
      description: |
        Automated monitoring of AlienVault OTX (Open Threat Exchange) threat intelligence in Zabbix.
        This template uses an external Python script to:
        - Discover and track IOCs (Indicators of Compromise) from OTX pulses within a configurable time window
        - Enrich each IOC with metadata: first seen, last seen, pulse name, tags, references, and threat type
        - Monitor IOC severity/confidence and trigger alerts for high-severity threats
        - Track pulse count and last update time for OTX data
        - Provide robust error handling and Zabbix-friendly output (safe defaults, clear errors)
        - Support flexible configuration via macros and environment variables (API key, endpoint, timeout, debug)
        - Optimise performance with in-script caching to minimise redundant API calls
        
        Author: 'Simon Jackson / @sjackson0109'
      vendor:
        name: AlienVault
        version: '2.0'
      groups:
        - name: Templates
      items:
        - uuid: ee887d7f9fca43b5911f909c374a6788
          name: 'Threat Geo Map'
          type: EXTERNAL
          key: 'otx.geomap[{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
          delay: 1h
          history: 30d
          value_type: TEXT
          trends: '0'
          description: 'Geographic distribution of threats from OTX.'
          tags:
            - tag: integration
              value: alienvault_otx
            - tag: otx_type
              value: threat_intel
        - uuid: 990ea57087194d338b7829d22f58652a
          name: 'IOC Type Distribution'
          type: EXTERNAL
          key: 'otx.ioctypes[{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
          delay: 1h
          history: 30d
          value_type: TEXT
          trends: '0'
          description: 'Distribution of IOC types (IP, domain, hash, etc.) from OTX.'
          tags:
            - tag: integration
              value: alienvault_otx
            - tag: otx_type
              value: threat_intel
        - uuid: b7e2c4e14a2b4c4d94b8a2b3c4d5e6f2
          name: 'OTX Last Update Time'
          type: EXTERNAL
          key: 'otx.lastupdate[{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
          delay: 1h
          history: 30d
          value_type: TEXT
          trends: '0'
          description: 'Last update timestamp from AlienVault OTX API.'
          tags:
            - tag: integration
              value: alienvault_otx
            - tag: otx_type
              value: api_health
          triggers:
            - uuid: d7e8f9a44b5c41bea4b8a2b3c4d5e6fa
              expression: 'nodata(/Alien Vault OTX/otx.lastupdate[{$OTX_API_KEY},{$OTX_SINCE_HOURS}],2h)=1'
              name: 'OTX data not updated for over 2 hours'
              priority: HIGH
              tags:
                - tag: event
                  value: data_stale
                - tag: integration
                  value: alienvault_otx
        - uuid: 262cc010241445fd95d490bbeb76b7fc
          name: 'Pulse Activity'
          type: EXTERNAL
          key: 'otx.pulseactivity[{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
          delay: 1h
          history: 30d
          value_type: TEXT
          trends: '0'
          description: 'Recent pulse activity from AlienVault OTX.'
          tags:
            - tag: integration
              value: alienvault_otx
            - tag: otx_type
              value: threat_intel
        - uuid: b3b6e2e24c2d4e3a94b8a2b3c4d5e6f1
          name: 'OTX Pulses Count (last {$OTX_SINCE_HOURS}h)'
          type: EXTERNAL
          key: 'otx.pulses[{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
          delay: 1h
          history: 90d
          tags:
            - tag: integration
              value: alienvault_otx
            - tag: otx_type
              value: api_health
          triggers:
            - uuid: c6d7e8f94a8b41be84b8a2b3c4d5e6f9
              expression: 'last(/Alien Vault OTX/otx.pulses[{$OTX_API_KEY},{$OTX_SINCE_HOURS}])=0'
              name: 'No new OTX indicators in last {$OTX_SINCE_HOURS} hours'
              priority: AVERAGE
              tags:
                - tag: event
                  value: no_new_iocs
                - tag: integration
                  value: alienvault_otx
        - uuid: e6f1a2b34c5d4e3194b8a2b3c4d5e6f3
          name: 'Response Actions'
          type: EXTERNAL
          key: 'otx.response[{$OTX_API_KEY}]'
          delay: 1h
          history: 30d
          value_type: TEXT
          trends: '0'
          tags:
            - tag: integration
              value: alienvault_otx
            - tag: otx_type
              value: response_action
        - uuid: 0b3058b1e7c84ccbaba8bf15c1fcf296
          name: 'Threat Timeline'
          type: EXTERNAL
          key: 'otx.timeline[{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
          delay: 1h
          history: 30d
          value_type: TEXT
          trends: '0'
          description: 'Timeline of threat activity from OTX pulses.'
          tags:
            - tag: integration
              value: alienvault_otx
            - tag: otx_type
              value: threat_intel
      discovery_rules:
        - uuid: f1a2b3c44d5e4fa294b8a2b3c4d5e6f4
          name: 'AlienVault OTX IOC Discovery'
          type: EXTERNAL
          key: 'otx.discover[{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
          delay: 1h
          filter:
            conditions:
              - macro: '{#TAGS}'
                value: '{$OTX_EXCLUDE_TAGS}'
                operator: NOT_MATCHES_REGEX
                formulaid: A
              - macro: '{#TYPE}'
                value: '{$OTX_INCLUDE_TYPES}'
                formulaid: B
              - macro: '{#TYPE}'
                value: '{$OTX_EXCLUDE_TYPES}'
                operator: NOT_MATCHES_REGEX
                formulaid: C
              - macro: '{#VALUE}'
                value: .+
                formulaid: D
          item_prototypes:
            - uuid: a2b3c4d54e6f41b894b8a2b3c4d5e6fb
              name: 'OTX IOC First Seen {#TYPE}: {#VALUE}'
              type: DEPENDENT
              key: 'otx.ioc.first_seen[{#TYPE},{#VALUE}]'
              delay: '0'
              value_type: TEXT
              trends: '0'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.{#FIRST_SEEN}'
              master_item:
                key: 'otx.ioc[{#TYPE},{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              tags:
                - tag: ioc_type
                  value: '{#TYPE}'
            - uuid: b3c4d5e64f1a41b994b8a2b3c4d5e6fc
              name: 'OTX IOC Last Seen {#TYPE}: {#VALUE}'
              type: DEPENDENT
              key: 'otx.ioc.last_seen[{#TYPE},{#VALUE}]'
              delay: '0'
              value_type: TEXT
              trends: '0'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.{#LAST_SEEN}'
              master_item:
                key: 'otx.ioc[{#TYPE},{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              tags:
                - tag: ioc_type
                  value: '{#TYPE}'
            - uuid: c4d5e6f14a2b41ba94b8a2b3c4d5e6fd
              name: 'OTX IOC Pulse Name {#TYPE}: {#VALUE}'
              type: DEPENDENT
              key: 'otx.ioc.pulse_name[{#TYPE},{#VALUE}]'
              delay: '0'
              value_type: TEXT
              trends: '0'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.{#PULSE_NAME}'
              master_item:
                key: 'otx.ioc[{#TYPE},{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              tags:
                - tag: ioc_type
                  value: '{#TYPE}'
            - uuid: e6f1a2b34c5d41bab4b8a2b3c4d5e6ff
              name: 'OTX IOC References {#TYPE}: {#VALUE}'
              type: DEPENDENT
              key: 'otx.ioc.references[{#TYPE},{#VALUE}]'
              delay: '0'
              value_type: TEXT
              trends: '0'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.{#REFERENCES}'
              master_item:
                key: 'otx.ioc[{#TYPE},{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              tags:
                - tag: ioc_type
                  value: '{#TYPE}'
            - uuid: d5e6f1a24b3c41baa4b8a2b3c4d5e6fe
              name: 'OTX IOC Tags {#TYPE}: {#VALUE}'
              type: DEPENDENT
              key: 'otx.ioc.tags[{#TYPE},{#VALUE}]'
              delay: '0'
              value_type: TEXT
              trends: '0'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.{#TAGS}'
              master_item:
                key: 'otx.ioc[{#TYPE},{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              tags:
                - tag: ioc_type
                  value: '{#TYPE}'
              trigger_prototypes:
                - uuid: a4b5c6d74e8f41bd84b8a2b3c4d5e6f7
                  expression: 'find(/Alien Vault OTX/otx.ioc.tags[{#TYPE},{#VALUE}],#1,"regexp","{$OTX_TAGS_CRITICAL}")=1'
                  name: 'OTX IOC with Critical Tag: {#VALUE}'
                  priority: DISASTER
                  tags:
                    - tag: ioc_type
                      value: '{#TYPE}'
                    - tag: otx_tag
                      value: '{#TAGS}'
                    - tag: severity
                      value: disaster
                - uuid: b5c6d7e84f9a41bd94b8a2b3c4d5e6f8
                  expression: 'find(/Alien Vault OTX/otx.ioc.tags[{#TYPE},{#VALUE}],#1,"regexp","{$OTX_TAGS_HIGH}")=1'
                  name: 'OTX IOC with High Tag: {#VALUE}'
                  priority: HIGH
                  tags:
                    - tag: ioc_type
                      value: '{#TYPE}'
                    - tag: otx_tag
                      value: '{#TAGS}'
                    - tag: severity
                      value: high
            - uuid: f1a2b3c44d5e41bbb4b8a2b3c4d5e6f0
              name: 'OTX IOC Threat Type {#TYPE}: {#VALUE}'
              type: DEPENDENT
              key: 'otx.ioc.threat_type[{#TYPE},{#VALUE}]'
              delay: '0'
              value_type: TEXT
              trends: '0'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.{#THREAT_TYPE}'
              master_item:
                key: 'otx.ioc[{#TYPE},{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              tags:
                - tag: ioc_type
                  value: '{#TYPE}'
            - uuid: e5f6a1b24c3d41b694b8a2b3c4d5e6f9
              name: 'OTX IOC {#TYPE}: {#VALUE}'
              type: EXTERNAL
              key: 'otx.ioc[{#TYPE},{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              delay: 1h
              history: 30d
              value_type: TEXT
              trends: '0'
              tags:
                - tag: ioc_type
                  value: '{#TYPE}'
                - tag: otx_tag
                  value: '{#TAGS}'
                - tag: threat_type
                  value: '{#THREAT_TYPE}'
            - uuid: b2c3d4e54a6a41b394b8a2b3c4d5e6f6
              name: 'OTX IOC Severity Domain: {#VALUE}'
              type: EXTERNAL
              key: 'otx.severity[domain,{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              delay: 1h
              history: 30d
              preprocessing:
                - type: JAVASCRIPT
                  parameters:
                    - 'return ("domain" === value["{#TYPE}"]) ? value["{#SEVERITY}"] : null;'
              tags:
                - tag: ioc_type
                  value: '{#TYPE}'
                - tag: otx_tag
                  value: '{#TAGS}'
                - tag: threat_type
                  value: '{#THREAT_TYPE}'
              trigger_prototypes:
                - uuid: c5d6e7f84a3b41bc84b8a2b3c4d5e6f3
                  expression: 'last(/Alien Vault OTX/otx.severity[domain,{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}])>{$SEVERITY_THRESHOLD}'
                  name: 'High severity OTX Domain IOC: {#VALUE}'
                  priority: HIGH
                  tags:
                    - tag: ioc_type
                      value: '{#TYPE}'
                    - tag: severity
                      value: high
            - uuid: d4e5f6a14b2c41b594b8a2b3c4d5e6f8
              name: 'OTX IOC Severity Hash: {#VALUE}'
              type: EXTERNAL
              key: 'otx.severity[file_hash,{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              delay: 1h
              history: 30d
              preprocessing:
                - type: JAVASCRIPT
                  parameters:
                    - 'return ("file_hash" === value["{#TYPE}"]) ? value["{#SEVERITY}"] : null;'
              tags:
                - tag: ioc_type
                  value: '{#TYPE}'
                - tag: otx_tag
                  value: '{#TAGS}'
                - tag: threat_type
                  value: '{#THREAT_TYPE}'
              trigger_prototypes:
                - uuid: e7f8a3b44c5d41bc84b8a2b3c4d5e6f5
                  expression: 'last(/Alien Vault OTX/otx.severity[file_hash,{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}])>{$SEVERITY_THRESHOLD}'
                  name: 'High severity OTX Hash IOC: {#VALUE}'
                  priority: HIGH
                  tags:
                    - tag: ioc_type
                      value: '{#TYPE}'
                    - tag: severity
                      value: high
            - uuid: a1b2c3d44e5641b294b8a2b3c4d5e6f5
              name: 'OTX IOC Severity IP: {#VALUE}'
              type: EXTERNAL
              key: 'otx.severity[ip,{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              delay: 1h
              history: 30d
              preprocessing:
                - type: JAVASCRIPT
                  parameters:
                    - 'return ("ip" === value["{#TYPE}"]) ? value["{#SEVERITY}"] : null;'
              tags:
                - tag: ioc_type
                  value: '{#TYPE}'
                - tag: otx_tag
                  value: '{#TAGS}'
                - tag: threat_type
                  value: '{#THREAT_TYPE}'
              trigger_prototypes:
                - uuid: b4c5d6e74f8a41bcb4b8a2b3c4d5e6f2
                  expression: 'last(/Alien Vault OTX/otx.severity[ip,{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}])>{$SEVERITY_THRESHOLD}'
                  name: 'High severity OTX IP IOC: {#VALUE}'
                  priority: HIGH
                  tags:
                    - tag: ioc_type
                      value: '{#TYPE}'
                    - tag: severity
                      value: high
            - uuid: c3d4e5f64a1b41b494b8a2b3c4d5e6f7
              name: 'OTX IOC Severity URL: {#VALUE}'
              type: EXTERNAL
              key: 'otx.severity[url,{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              delay: 1h
              history: 30d
              preprocessing:
                - type: JAVASCRIPT
                  parameters:
                    - 'return ("url" === value["{#TYPE}"]) ? value["{#SEVERITY}"] : null;'
              tags:
                - tag: ioc_type
                  value: '{#TYPE}'
                - tag: otx_tag
                  value: '{#TAGS}'
                - tag: threat_type
                  value: '{#THREAT_TYPE}'
              trigger_prototypes:
                - uuid: d6e7f8a34b5c41bc84b8a2b3c4d5e6f4
                  expression: 'last(/Alien Vault OTX/otx.severity[url,{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}])>{$SEVERITY_THRESHOLD}'
                  name: 'High severity OTX URL IOC: {#VALUE}'
                  priority: HIGH
                  tags:
                    - tag: ioc_type
                      value: '{#TYPE}'
                    - tag: severity
                      value: high
            - uuid: f6a1b2c34d5f41b794b8a2b3c4d5e6fa
              name: 'OTX IOC Severity {#TYPE}: {#VALUE}'
              type: EXTERNAL
              key: 'otx.severity[{#TYPE},{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              delay: 1h
              history: 30d
              tags:
                - tag: ioc_type
                  value: '{#TYPE}'
                - tag: otx_tag
                  value: '{#TAGS}'
                - tag: threat_type
                  value: '{#THREAT_TYPE}'
              trigger_prototypes:
                - uuid: f8a3b4c54d6e41bc84b8a2b3c4d5e6f6
                  expression: 'last(/Alien Vault OTX/otx.severity[{#TYPE},{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}])>{$SEVERITY_THRESHOLD}'
                  name: 'High severity OTX IOC {#TYPE}: {#VALUE}'
                  priority: WARNING
                  tags:
                    - tag: ioc_type
                      value: '{#TYPE}'
                    - tag: severity
                      value: warning
          graph_prototypes:
            - uuid: 2e7c1b2a4b2c4d4e84a1b2c3d4e5f6a7
              name: 'IOC Severity: {#TYPE} {#VALUE}'
              graph_items:
                - color: 199C0D
                  calc_fnc: ALL
                  item:
                    host: 'Alien Vault OTX'
                    key: 'otx.severity[{#TYPE},{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
      tags:
        - tag: Author
          value: 'Simon Jackson'
      macros:
        - macro: '{$OTX_API_ENDPOINT}'
          value: 'https://otx.alienvault.com/api/v1'
          description: 'OTX API endpoint URL (default: https://otx.alienvault.com/api/v1)'
        - macro: '{$OTX_API_KEY}'
          description: 'AlienVault OTX API key (keep secret). Use Zabbix secrets/vault if available.'
        - macro: '{$OTX_EXCLUDE_TAGS}'
          value: ^$
          description: 'Regex pattern for tags to exclude (e.g. test|benign). Use ^$ to exclude none.'
        - macro: '{$OTX_EXCLUDE_TYPES}'
          value: ^$
          description: 'Regex pattern for IOC types to exclude (e.g. ^(email|hostname)$). Use ^$ to exclude none.'
        - macro: '{$OTX_INCLUDE_TYPES}'
          value: '.*'
          description: 'Regex pattern for IOC types to include (e.g. ^(IPv4|domain|URL)$). Use .* to include all.'
        - macro: '{$OTX_SINCE_HOURS}'
          value: '24'
          description: 'Time window (hours) for IOC discovery (default: 24)'
        - macro: '{$OTX_TAGS_CRITICAL}'
          value: 'ransomware,phishing,malware,botnet,APT'
          description: 'Tags that trigger critical alerts (e.g. ransomware,phishing,malware)'
        - macro: '{$OTX_TAGS_HIGH}'
          value: 'exploit,ddos,spam'
          description: 'Tags that trigger high alerts'
        - macro: '{$OTX_TIMEOUT}'
          value: '30'
          description: 'OTX API request timeout in seconds (default: 30)'
        - macro: '{$SEVERITY_THRESHOLD}'
          value: '7'
          description: 'Minimum severity/confidence for alerting (default: 7)'
      dashboards:
        - uuid: b1e2c3d44a2b4c4d94b8a2b3c4d5e6f1
          name: 'AlienVault OTX - Threat Overview'
          display_period: '3600'
          pages:
            - name: 'Threat Intelligence'
              widgets:
                - type: ITEM
                  name: 'Pulse Count'
                  width: '4'
                  height: '3'
                  fields:
                    - type: ITEM
                      name: itemid.0
                      value:
                        host: 'Alien Vault OTX'
                        key: 'otx.pulses[{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
                - type: ITEM
                  name: 'Threat Timeline'
                  'y': '3'
                  width: '6'
                  height: '3'
                  fields:
                    - type: ITEM
                      name: itemid.0
                      value:
                        host: 'Alien Vault OTX'
                        key: 'otx.timeline[{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
                - type: ITEM
                  name: 'Geo Map'
                  'y': '6'
                  width: '6'
                  height: '4'
                  fields:
                    - type: ITEM
                      name: itemid.0
                      value:
                        host: 'Alien Vault OTX'
                        key: 'otx.geomap[{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
                - type: ITEM
                  name: 'Last Update Time'
                  x: '4'
                  width: '4'
                  height: '3'
                  fields:
                    - type: ITEM
                      name: itemid.0
                      value:
                        host: 'Alien Vault OTX'
                        key: 'otx.lastupdate[{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
                - type: ITEM
                  name: 'Pulse Activity'
                  x: '6'
                  'y': '3'
                  width: '6'
                  height: '3'
                  fields:
                    - type: ITEM
                      name: itemid.0
                      value:
                        host: 'Alien Vault OTX'
                        key: 'otx.pulseactivity[{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
                - type: ITEM
                  name: 'Response Actions'
                  x: '6'
                  'y': '6'
                  width: '6'
                  height: '4'
                  fields:
                    - type: ITEM
                      name: itemid.0
                      value:
                        host: 'Alien Vault OTX'
                        key: 'otx.response[{$OTX_API_KEY}]'
                - type: ITEM
                  name: 'IOC Type Distribution'
                  x: '8'
                  width: '4'
                  height: '3'
                  fields:
                    - type: ITEM
                      name: itemid.0
                      value:
                        host: 'Alien Vault OTX'
                        key: 'otx.ioctypes[{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
            - name: 'Graph Prototypes'
              widgets:
                - type: GRAPH_PROTOTYPE
                  name: 'IOC Severity (Dynamic)'
                  width: '12'
                  height: '5'
                  fields:
                    - type: GRAPH_PROTOTYPE
                      name: graphid.0
                      value:
                        host: 'Alien Vault OTX'
                        name: 'IOC Severity: {#TYPE} {#VALUE}'
            - name: 'Custom Playbook Panel'
              widgets:
                - type: PLAIN_TEXT
                  name: 'Incident Response Playbooks'
                  width: '12'
                  height: '4'
                  fields:
                    - type: ITEM
                      name: itemid.0
                      value:
                        host: 'Alien Vault OTX'
                        key: 'otx.response[{$OTX_API_KEY}]'
      valuemaps:
        - uuid: a2b3c4d54e6f4a1b94b8a2b3c4d5e6f0
          name: 'OTX IOC Severity Map'
          mappings:
            - value: '0'
              newvalue: None
            - value: 1-3
              newvalue: Low
            - value: 4-6
              newvalue: Medium
            - value: 7-10
              newvalue: High
            - newvalue: Unknown

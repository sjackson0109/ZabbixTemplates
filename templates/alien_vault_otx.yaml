zabbix_export:
  version: '7.0'
  date: '2025-07-16T12:00:00Z'
  groups:
    - name: Templates
  templates:
    - name: 'Alien Vault OTX'
      description: |-
        Automated monitoring of AlienVault OTX (Open Threat Exchange) threat intelligence in Zabbix.
        This template uses an external Python script to:
        - Discover and track IOCs (Indicators of Compromise) from OTX pulses within a configurable time window
        - Enrich each IOC with metadata: first seen, last seen, pulse name, tags, references, and threat type
        - Monitor IOC severity/confidence and trigger alerts for high-severity threats
        - Track pulse count and last update time for OTX data
        - Provide robust error handling and Zabbix-friendly output (safe defaults, clear errors)
        - Support flexible configuration via macros and environment variables (API key, endpoint, timeout, debug)
        - Optimize performance with in-script caching to minimize redundant API calls

        Author: Simon Jackson / @sjackson0109
      groups:
        - name: Templates
      items:
        - name: 'OTX Pulses Count (last {$OTX_SINCE_HOURS}h)'
          type: EXTERNAL
          key: 'otx.pulses[{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
          delay: 1h
          history: 90d
          trends: 365d
          value_type: UNSIGNED
        - name: 'OTX Last Update Time'
          type: EXTERNAL
          key: 'otx.lastupdate[{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
          delay: 1h
          history: 30d
          trends: 365d
          value_type: TEXT
        - name: 'OTX API Health Status'
          type: EXTERNAL
          key: 'otx.health[{$OTX_API_KEY}]'
          delay: 1h
          history: 30d
          trends: 365d
          value_type: TEXT
      discovery_rules:
        - name: 'AlienVault OTX IOC Discovery'
          type: EXTERNAL
          key: 'otx.discover[{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
          delay: 1h
          filter:
            conditions:
              - macro: '{#VALUE}'
                operator: MATCHES_REGEX
                value: '.+'
              - macro: '{#SEVERITY}'
                operator: GREATER_OR_EQUAL
                value: '{$OTX_MIN_SEVERITY}'
              # Include/exclude IOC types if macros are set
              - macro: '{#TYPE}'
                operator: IN
                value: '{$OTX_INCLUDE_TYPES}'
              - macro: '{#TYPE}'
                operator: NOT_IN
                value: '{$OTX_EXCLUDE_TYPES}'
              # Exclude IOCs with certain tags
              - macro: '{#TAGS}'
                operator: NOT_MATCHES_REGEX
                value: '{$OTX_EXCLUDE_TAGS}'
          item_prototypes:
            # Type-specific severity item prototypes for granular triggers
            - name: 'OTX IOC Severity IP: {#VALUE}'
              type: EXTERNAL
              key: 'otx.severity[ip,{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              delay: 1h
              history: 30d
              trends: 365d
              value_type: UNSIGNED
              preprocessing:
                - type: JAVASCRIPT
                  parameters:
                    - 'return ("ip" === value["{#TYPE}"]) ? value["{#SEVERITY}"] : null;'
            - name: 'OTX IOC Severity Domain: {#VALUE}'
              type: EXTERNAL
              key: 'otx.severity[domain,{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              delay: 1h
              history: 30d
              trends: 365d
              value_type: UNSIGNED
              preprocessing:
                - type: JAVASCRIPT
                  parameters:
                    - 'return ("domain" === value["{#TYPE}"]) ? value["{#SEVERITY}"] : null;'
            - name: 'OTX IOC Severity URL: {#VALUE}'
              type: EXTERNAL
              key: 'otx.severity[url,{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              delay: 1h
              history: 30d
              trends: 365d
              value_type: UNSIGNED
              preprocessing:
                - type: JAVASCRIPT
                  parameters:
                    - 'return ("url" === value["{#TYPE}"]) ? value["{#SEVERITY}"] : null;'
            - name: 'OTX IOC Severity Hash: {#VALUE}'
              type: EXTERNAL
              key: 'otx.severity[file_hash,{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              delay: 1h
              history: 30d
              trends: 365d
              value_type: UNSIGNED
              preprocessing:
                - type: JAVASCRIPT
                  parameters:
                    - 'return ("file_hash" === value["{#TYPE}"]) ? value["{#SEVERITY}"] : null;'
            - name: 'OTX IOC {#TYPE}: {#VALUE}'
              type: EXTERNAL
              key: 'otx.ioc[{#TYPE},{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              delay: 1h
              history: 30d
              trends: 365d
              value_type: TEXT
            - name: 'OTX IOC Severity {#TYPE}: {#VALUE}'
              type: EXTERNAL
              key: 'otx.severity[{#TYPE},{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              delay: 1h
              history: 30d
              trends: 365d
              value_type: UNSIGNED
            - name: 'OTX IOC First Seen {#TYPE}: {#VALUE}'
              type: DEPENDENT
              key: 'otx.ioc.first_seen[{#TYPE},{#VALUE}]'
              master_item:
                key: 'otx.ioc[{#TYPE},{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              delay: '0'
              value_type: TEXT
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.{#FIRST_SEEN}'
            - name: 'OTX IOC Last Seen {#TYPE}: {#VALUE}'
              type: DEPENDENT
              key: 'otx.ioc.last_seen[{#TYPE},{#VALUE}]'
              master_item:
                key: 'otx.ioc[{#TYPE},{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              delay: '0'
              value_type: TEXT
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.{#LAST_SEEN}'
            - name: 'OTX IOC Pulse Name {#TYPE}: {#VALUE}'
              type: DEPENDENT
              key: 'otx.ioc.pulse_name[{#TYPE},{#VALUE}]'
              master_item:
                key: 'otx.ioc[{#TYPE},{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              delay: '0'
              value_type: TEXT
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.{#PULSE_NAME}'
            - name: 'OTX IOC Tags {#TYPE}: {#VALUE}'
              type: DEPENDENT
              key: 'otx.ioc.tags[{#TYPE},{#VALUE}]'
              master_item:
                key: 'otx.ioc[{#TYPE},{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              delay: '0'
              value_type: TEXT
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.{#TAGS}'
            - name: 'OTX IOC References {#TYPE}: {#VALUE}'
              type: DEPENDENT
              key: 'otx.ioc.references[{#TYPE},{#VALUE}]'
              master_item:
                key: 'otx.ioc[{#TYPE},{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              delay: '0'
              value_type: TEXT
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.{#REFERENCES}'
            - name: 'OTX IOC Threat Type {#TYPE}: {#VALUE}'
              type: DEPENDENT
              key: 'otx.ioc.threat_type[{#TYPE},{#VALUE}]'
              master_item:
                key: 'otx.ioc[{#TYPE},{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}]'
              delay: '0'
              value_type: TEXT
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.{#THREAT_TYPE}'
          trigger_prototypes:
            - name: 'OTX API health check failed'
              expression: 'find(/Alien Vault OTX/otx.health[{$OTX_API_KEY}],,"fail")=1'
              priority: HIGH
            - name: 'High severity OTX IP IOC: {#VALUE}'
              expression: 'last(/Alien Vault OTX/otx.severity[ip,{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}])>{$SEVERITY_THRESHOLD}'
              priority: HIGH
            - name: 'High severity OTX Domain IOC: {#VALUE}'
              expression: 'last(/Alien Vault OTX/otx.severity[domain,{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}])>{$SEVERITY_THRESHOLD}'
              priority: HIGH
            - name: 'High severity OTX URL IOC: {#VALUE}'
              expression: 'last(/Alien Vault OTX/otx.severity[url,{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}])>{$SEVERITY_THRESHOLD}'
              priority: HIGH
            - name: 'High severity OTX Hash IOC: {#VALUE}'
              expression: 'last(/Alien Vault OTX/otx.severity[file_hash,{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}])>{$SEVERITY_THRESHOLD}'
              priority: HIGH
            - name: 'High severity OTX IOC {#TYPE}: {#VALUE}'
              expression: 'last(/Alien Vault OTX/otx.severity[{#TYPE},{#VALUE},{$OTX_API_KEY},{$OTX_SINCE_HOURS}])>{$SEVERITY_THRESHOLD}'
              priority: WARNING
            # Macro-driven tag triggers for critical tags
            - name: 'OTX IOC with Critical Tag: {#VALUE}'
              expression: 'regexp(/Alien Vault OTX/otx.ioc.tags[{#TYPE},{#VALUE}],"({$OTX_TAGS_CRITICAL})")=1'
              priority: DISASTER
            # Macro-driven tag triggers for high tags
            - name: 'OTX IOC with High Tag: {#VALUE}'
              expression: 'regexp(/Alien Vault OTX/otx.ioc.tags[{#TYPE},{#VALUE}],"({$OTX_TAGS_HIGH})")=1'
              priority: HIGH
            # Example: add more tag triggers as needed
        # Security: API key macro should be stored securely and never logged or exposed in UI or error messages.
        # WARNING: Do not expose API keys in logs, screens, or error messages. Use Zabbix secrets/vaults if available.
      triggers:
        - name: 'No new OTX indicators in last {$OTX_SINCE_HOURS} hours'
          expression: 'last(/Alien Vault OTX/otx.pulses[{$OTX_API_KEY},{$OTX_SINCE_HOURS}])=0'
          priority: AVERAGE
        - name: 'OTX data not updated for over 2 hours'
          expression: 'nodata(/Alien Vault OTX/otx.lastupdate[{$OTX_API_KEY},{$OTX_SINCE_HOURS}],2h)=1'
          priority: HIGH
      macros:
        - macro: '{$OTX_API_KEY}'
          value: ''
          description: 'AlienVault OTX API key (keep secret). Use Zabbix secrets/vault if available.'
        - macro: '{$OTX_API_ENDPOINT}'
          value: 'https://otx.alienvault.com/api/v1'
          description: 'OTX API endpoint URL (default: https://otx.alienvault.com/api/v1)'
        - macro: '{$OTX_TIMEOUT}'
          value: '30'
          description: 'OTX API request timeout in seconds (default: 30)'
        - macro: '{$OTX_SINCE_HOURS}'
          value: '24'
          description: 'Time window (hours) for IOC discovery (default: 24)'
        - macro: '{$SEVERITY_THRESHOLD}'
          value: '7'
          description: 'Minimum severity/confidence for alerting (default: 7)'
        - macro: '{$OTX_MIN_SEVERITY}'
          value: '1'
          description: 'Minimum severity/confidence for IOC discovery  (default: 1)'
        - macro: '{$OTX_INCLUDE_TYPES}'
          value: ''
          description: 'IOC types to include in discovery (e.g. IPv4,domain,URL), not blank=all'
        - macro: '{$OTX_EXCLUDE_TYPES}'
          value: ''
          description: 'IOC types to exclude from discovery (e.g. email,hostname)'
        - macro: '{$OTX_EXCLUDE_TAGS}'
          value: ''
          description: 'Tags to exclude from discovery (e.g. test,benign)'
        - macro: '{$OTX_TAGS_CRITICAL}'
          value: 'ransomware,phishing,malware,botnet,APT'
          description: 'Tags that trigger critical alerts (e.g. ransomware,phishing,malware)'
        - macro: '{$OTX_TAGS_HIGH}'
          value: 'exploit,ddos,spam'
          description: 'Tags that trigger high alerts'
      value_maps:
        - name: 'OTX IOC Severity Map'
          mappings:
            - value: '0'
              newvalue: 'None'
            - value: '1-3'
              newvalue: 'Low'
            - value: '4-6'
              newvalue: 'Medium'
            - value: '7-10'
              newvalue: 'High'
            - value: ''
              newvalue: 'Unknown'
            - value: 'error'
              newvalue: 'Error'        
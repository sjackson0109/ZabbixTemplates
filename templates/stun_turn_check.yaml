zabbix_export:
  version: '7.0'
  template_groups:
  - uuid: d4896d8a2e5d45d7a83cc0b087941163
    name: Network/Communication
  templates:
  - uuid: a87a5290e6d04b389e343222f58104ff
    template: STUN and TURN Checks
    name: STUN and TURN Checks
    vendor:
      name: 'Simon Jackson'
      version: '1.0'
    description: 'STUN/TURN monitoring template using get_stun_turn_checks.py external script.

      Features:
      - Auto-discovery of STUN/TURN services
      - Fast monitoring with 2-second timeout
      - Support for UDP, TCP, TLS transports
      - TURN authentication support

      Installation:
      1. Copy get_stun_turn_checks.py to /usr/lib/zabbix/externalscripts/
      2. Make executable: chmod +x /usr/lib/zabbix/externalscripts/get_stun_turn_checks.py
      3. Import this template
      4. Configure host/template macros as needed

      Author: Simon Jackson (@sjackson0109)
      '
    groups:
    - name: "Templates/Applications"
    tags:
    - tag: Author 
      value: 'Simon Jackson'
    macros:
    - macro: '{$PORT}'
      value: '3478'
      description: Port for STUN/TURN service
    - macro: '{$STUN_TIMEOUT}'
      value: '2'
      description: Timeout for STUN requests in seconds
    - macro: '{$TRANSPORT}'
      value: 'udp'
      description: Transport protocol for STUN/TURN (udp, tcp, tls)
    - macro: '{$TURN_USERNAME}'
      value: ''
      description: TURN username for authentication
    - macro: '{$TURN_PASSWORD}'
      value: ''
      description: TURN password for authentication
    - macro: '{$TURN_TIMEOUT}'
      value: '2'
      description: Timeout for TURN requests in seconds
    discovery_rules:
    - uuid: 018374ec15a94f5d97168455b1df018c
      name: STUN/TURN Service Discovery
      key: get_stun_turn_checks.py[--discover]
      delay: 1h
      lifetime: 7d
      item_prototypes:
      - uuid: 373eb1f980e246869620d11542713b31
        name: STUN {#TRANSPORT}:{#PORT}
        key: get_stun_turn_checks.py[{HOST.CONN},--transport,{#TRANSPORT},--port,{#PORT},--check,--timeout,{$STUN_TIMEOUT}]
        value_type: FLOAT
        delay: 2m
        history: 7d
        trends: 90d
        description: 'STUN service status: 1=OK, 0=FAIL'
        valuemap:
          name: stun.turn.status
        trigger_prototypes:
        - uuid: 01d21617818440538ccc6d0c9f6d8bb2
          name: STUN {#TRANSPORT}:{#PORT} is down
          expression: last(/STUN and TURN Checks/get_stun_turn_checks.py[{HOST.CONN},--transport,{#TRANSPORT},--port,{#PORT},--check,--timeout,{$STUN_TIMEOUT}])=0
          priority: HIGH
      - uuid: 21b7229ee9ec491fa390874b2cbda3fc
        name: TURN {#TRANSPORT}:{#PORT}
        key: get_stun_turn_checks.py[{HOST.CONN},--transport,{#TRANSPORT},--port,{#PORT},--check,--turn-mode,--username,{$TURN_USERNAME},--password,{$TURN_PASSWORD},--timeout,{$TURN_TIMEOUT}]
        value_type: FLOAT
        delay: 2m
        history: 7d
        trends: 90d
        description: 'TURN service status: 1=OK, 0=FAIL'
        valuemap:
          name: stun.turn.status
        trigger_prototypes:
        - uuid: bba50316953f4988b04ffae3225a7edb
          name: TURN {#TRANSPORT}:{#PORT} is down
          expression: last(/STUN and TURN Checks/get_stun_turn_checks.py[{HOST.CONN},--transport,{#TRANSPORT},--port,{#PORT},--check,--turn-mode,--username,{$TURN_USERNAME},--password,{$TURN_PASSWORD},--timeout,{$TURN_TIMEOUT}])=0
          priority: HIGH
    valuemaps:
    - uuid: 4d5e6f7a8b9c4d1e8f3a4b5c6d7e8f9a
      name: stun.turn.status
      mappings:
        - value: '0'
          newvalue: FAIL
        - value: '1'
          newvalue: OK
